<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>南柯一梦</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="re学习总结软件安装安装IDA与DIE 基础流程 将文件拖到DIE中查看版本信息  ​			这里最重要的是软件的版本和编译器。   知道版本后用对应的IDA版本打开  ​			打开的时候，软件会自动识别相应的配置，我们一路默认就好  IDA的基础用法进入IDA后首先是下面这个页面 这里称这个界面为图表视图  Space键space键会使我们在图表视图和文本视图之间相互切换  F5键在上面无论哪两个">
<meta property="og:type" content="article">
<meta property="og:title" content="南柯一梦">
<meta property="og:url" content="http://gaoxudong.top/2023/06/01/re%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="南柯一梦">
<meta property="og:description" content="re学习总结软件安装安装IDA与DIE 基础流程 将文件拖到DIE中查看版本信息  ​			这里最重要的是软件的版本和编译器。   知道版本后用对应的IDA版本打开  ​			打开的时候，软件会自动识别相应的配置，我们一路默认就好  IDA的基础用法进入IDA后首先是下面这个页面 这里称这个界面为图表视图  Space键space键会使我们在图表视图和文本视图之间相互切换  F5键在上面无论哪两个">
<meta property="og:locale">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230114164055.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230114164703.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230114164729.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230114165430.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230114165730.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230114170521.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230114172302.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230115112853.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230115113410.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230115113848.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230115114012.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230115114749.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230115114943.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230115115240.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230115115406.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230115115416.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230115115718.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230115184015.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230115184641.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230115184405.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230115185131.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230115191155.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230115192618.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230115193142.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230115194135.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230115194958.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230115195329.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230115195701.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230115202922.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230115203121.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230116120415.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230116120503.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230116121058.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230116121434.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230116121503.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230116124830.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230116125045.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230116134748.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230116134906.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230116135543.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230116135729.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230116135844.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230116140014.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230116143004.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230116143127.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230116143141.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230116144822.jpg">
<meta property="og:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230116145048.jpg">
<meta property="article:published_time" content="2023-06-01T03:08:58.223Z">
<meta property="article:modified_time" content="2023-01-16T06:58:11.009Z">
<meta property="article:author" content="sharkhhhh">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://gaoxudong.top/assets/QQ%E6%88%AA%E5%9B%BE20230114164055.jpg">
  
    <link rel="alternative" href="/atom.xml" title="南柯一梦" type="application/atom+xml">
  
  
    <link rel="icon" href="http://7xkj1z.com1.z0.glb.clouddn.com/head.jpg">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  

  
<script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>

  
<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>


  
<meta name="generator" content="Hexo 6.3.0"></head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://7xkj1z.com1.z0.glb.clouddn.com/head.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/"></a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://github.com/smackgg/hexo-theme-smackdown">smackdown</a>
			        
			        </div>
				</section>
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="http://7xkj1z.com1.z0.glb.clouddn.com/head.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author"></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-re学习总结" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2023/06/01/re%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" class="article-date">
  	<time datetime="2023-06-01T03:08:58.223Z" itemprop="datePublished">2023-06-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="re学习总结"><a href="#re学习总结" class="headerlink" title="re学习总结"></a>re学习总结</h1><h2 id="软件安装"><a href="#软件安装" class="headerlink" title="软件安装"></a>软件安装</h2><p>安装IDA与DIE</p>
<h2 id="基础流程"><a href="#基础流程" class="headerlink" title="基础流程"></a>基础流程</h2><ul>
<li>将文件拖到DIE中查看版本信息</li>
</ul>
<p>​			这里最重要的是软件的版本和编译器。</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230114164055.jpg"></p>
<ul>
<li>知道版本后用对应的IDA版本打开</li>
</ul>
<p>​			打开的时候，软件会自动识别相应的配置，我们一路默认就好</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230114164703.jpg"></p>
<h2 id="IDA的基础用法"><a href="#IDA的基础用法" class="headerlink" title="IDA的基础用法"></a>IDA的基础用法</h2><p>进入IDA后首先是下面这个页面</p>
<p>这里称这个界面为<strong>图表视图</strong></p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230114164729.jpg"></p>
<h3 id="Space键"><a href="#Space键" class="headerlink" title="Space键"></a>Space键</h3><p>space键会使我们在<strong>图表视图</strong>和<strong>文本视图</strong>之间相互切换</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230114165430.jpg"></p>
<h3 id="F5键"><a href="#F5键" class="headerlink" title="F5键"></a>F5键</h3><p>在上面无论哪两个界面，F5都会进入伪代码的页面</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230114165730.jpg"></p>
<h3 id="X键"><a href="#X键" class="headerlink" title="X键"></a>X键</h3><p>在上述三个页面，选定<strong>函数</strong>、<strong>变量</strong>，再点X键就能查看相关引用</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230114170521.jpg"></p>
<h3 id="TAB键"><a href="#TAB键" class="headerlink" title="TAB键"></a>TAB键</h3><p>在伪代码、<strong>文本视图</strong>页面，选定函数或者变量，点击TAB，就能进入<strong>图表视图</strong>的页面，再次点击TAB会回到原来的页面</p>
<h3 id="R键与H键"><a href="#R键与H键" class="headerlink" title="R键与H键"></a>R键与H键</h3><p>R会将数字转换成字符</p>
<p>H会将10进制转成16进制</p>
<h3 id="CTRL-F"><a href="#CTRL-F" class="headerlink" title="CTRL+F"></a>CTRL+F</h3><p>在右边的函数框中点击CTRL+F，就能对函数进行搜索</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230114172302.jpg"></p>
<p>几个指令</p>
<h3 id="A指令"><a href="#A指令" class="headerlink" title="A指令"></a>A指令</h3><p>把当前的数据用字符串的形式来显示</p>
<h3 id="C指令"><a href="#C指令" class="headerlink" title="C指令"></a>C指令</h3><p>把当前的数据安照代码（code）的形式来显示</p>
<h3 id="D指令"><a href="#D指令" class="headerlink" title="D指令"></a>D指令</h3><p>把当前的数据用数据（data）的形式来显示</p>
<h3 id="U指令"><a href="#U指令" class="headerlink" title="U指令"></a>U指令</h3><p>把当前的数据用普通的原始字节的形式来显示（undefined未定义）</p>
<h2 id="RE的题型"><a href="#RE的题型" class="headerlink" title="RE的题型"></a>RE的题型</h2><h3 id="简单的改逻辑，改数据"><a href="#简单的改逻辑，改数据" class="headerlink" title="简单的改逻辑，改数据"></a>简单的改逻辑，改数据</h3><p>此类题比较简单，不需要太多的汇编知识，只通过反编译后伪代码就能得到相关的信息，修改关键数据后就能得到Flag</p>
<p>以这两道题为例</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230115112853.jpg"></p>
<p>打开后进入按<strong>F5</strong></p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230115113410.jpg"></p>
<p>观察伪代码发现逻辑不难，只要分数大于2018就能给出flag</p>
<p>所以在代码初始化的时候直接将分数置为2022，这样开局就能得到flag</p>
<p>显然<code>_startup()</code>是初始化游戏的函数，我们双击函数进入函数内部</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230115113848.jpg"></p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230115114012.jpg"></p>
<p>点击选定score后按<code>TAB</code>进入<strong>图表视图</strong></p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230115114749.jpg"></p>
<p>选定_score后<code>右键</code>，然后选择<code>Keypath</code>&gt;&gt;<code>Pather</code></p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230115114943.jpg"></p>
<p>将初始的0改为16进制的2022(0x7E6)</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230115115240.jpg"></p>
<p>就修改成功了，最后保存</p>
<p><code>Edit</code>&gt;&gt;<code>Patch Program</code>&gt;&gt;<code>Apply patches to</code>&gt;&gt;<code>Apply patches</code></p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230115115406.jpg"></p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230115115416.jpg"></p>
<p>效果图</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230115115718.jpg"></p>
<h3 id="花指令"><a href="#花指令" class="headerlink" title="花指令"></a>花指令</h3><blockquote>
<p>花指令实际上把它按照 “乱指令” 来理解可能更贴切一些。我们知道，汇编语言其实就是机器指令的符号化，从某种程度上看，它只是更容易理解一点的机器指令而已。每一条汇编语句，在汇编时，都会根据 cpu 特定的指令符号表将汇编指令翻译成二进制代码。</p>
<p>而日常应用中，我们通过 VC 的 IDE 或其它如 OD 等反汇编、反编译软件也可以将一个二进制程序反汇编成汇编代码。机器的一般格式为：指令＋数据。</p>
<p>而反汇编的大致过程是：首先会确定指令开始的首地址，然后根据这个指令字判断是哪个汇编语句，然后再将后面的数据反汇编出来。由此，我们可以看到，在这一步的反汇编过程中存在漏洞：如果有人故意将错误的机器指令放在了错误的位置，那反汇编时，就有可能连同后面的数据一起错误地反汇编出来，这样，我们看到的就可能是一个错误的反汇编代码。这就是 “花指令”，简而言之，花指令是利用了反汇编时单纯根据机器指令字来决定反汇编结果的漏洞。使得杀毒软件不能正常的判断病毒文件的构造。说通俗点就是 “杀毒软件是从头到脚按顺序来查找病毒。如果我们把病毒的头和脚颠倒位置。杀毒软件就找不到病毒了。”</p>
</blockquote>
<p>简而言之，花指令会使IDA中的<code>F5</code>失败</p>
<p>这时，就要我们手动调整</p>
<p>我们以一道题为例</p>
<p>21校赛的AskforU没搞出来，还是得懂汇编，花指令先跳了</p>
<p>搞了一天，搞出来了</p>
<p>刚进去看到的是这个样子，由于代码加了花所以对于<code>main()</code>,用<code>F5</code>是没反应的</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230115184015.jpg"></p>
<p><strong>首先我们明确，.text端中存储的是代码</strong></p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230115184641.jpg"></p>
<p>所以要将所有的数据用<code>C键</code>转换成代码</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230115184405.jpg"></p>
<p>修改完成之后发现这里有两个看起来像报错的东西，所以汇编可能有问题，我们来仔细分析一下</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230115185131.jpg"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">loc_4014D7:</span><br><span class="line">mov     [ebp-0DCh], eax</span><br><span class="line">call    sub_4018C0</span><br><span class="line">mov     [ebp-0E0h], eax</span><br><span class="line">call    near ptr loc_4014EF+4</span><br><span class="line">jmp     short near ptr loc_4014D7+1</span><br><span class="line">;-----------------------------------------</span><br><span class="line">loc_4014EF:</span><br><span class="line">add     eax, 83000000h</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>这段代码在第三行用<code>call</code>命令调用了<code>sub_4018C0</code>函数，这样是没问题的，因为<code>call</code>命令要调用函数</p>
<p>但是在第五行，出现了<code>call</code>命令调用<code>loc_4014EF+4</code>，联系后面代码可以看到，<code>loc_4014EF+4</code>是一个地址，所以这条命令是错误的，所以将其置为<code>NOP</code>（<code>选定代码</code>&gt;&gt;<code>D键</code>&gt;&gt;<code>CTRL+N</code>&gt;&gt;<code>C键</code>)</p>
<p>接着看第六行，通过<code>jmp</code>指令跳转到地址<code>loc_4014D7+1</code>处，第一感觉是没有问题的，但是<code>jmp</code>跳转到相应的地址之后就会执行相应地址存储的代码，，对于上面代码，6位的数据才组成这一段代码，如果<code>loc_4014D7+1</code>处开始就构不成一段代码，所以该条指令是错误的,将其置为<code>NOP</code></p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230115191155.jpg"></p>
<p>对于之后的代码分析也同理。</p>
<p>将这一大段中所有有问题的代码修改后，我们要让ida将这段代码识别为函数。</p>
<p>这里先申明一个概念，汇编中的函数必须由<code>retn</code>结尾，而且在函数开始时一般有这种标志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CC CC CC CC CC CC CC CC CC CC+ align 10h</span><br></pre></td></tr></table></figure>

<p>这个标志的下一行就是函数开始的第一行。</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230115192618.jpg"></p>
<p>所以，在选定函数的首行后按<code>P键</code>，就能将其识别为函数</p>
<p>这一段有好几个函数，都仿照上面的操作即可。</p>
<p>到此，<code>main()</code>就搞出来了，<code>F5</code>就能看到伪代码</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230115193142.jpg"></p>
<p>到这里就完成了四分之一了。继续加油</p>
<p>通过这个条状带可以看到，还有一段代码被ida识别错了，所以我们要继续修改</p>
<p>仔细看一下，标红的这段代码，逻辑是没有什么问题的，但是最后没有看到<code>retn</code></p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230115194135.jpg"></p>
<p>所以这构不成一个函数，所以就要考虑这段代码之前和之后的函数是不是被<code>ida</code>识别错了，将原本的一个函数识别成多段了。我们先往前找，找到上一个<code>retn</code></p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230115194958.jpg"></p>
<p>找到上面的<code>retn</code>但是由于retn前有数据，将数据转成代码后<code>retn</code>会消失，所以上上面一整个函数都是识别错误的。我们选定函数的首行，然后按<code>U键</code>就能取消这个函数的识别。</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230115195329.jpg"></p>
<p>之后发现函数不见了，代码变成了数据，我们要接着将数据变成代码(<code>C键</code>)(将之后所有的数据都改成代码)</p>
<p>之后继续查看逻辑的错误，发现</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230115195701.jpg"></p>
<p>这里逻辑和上面是一样的，所以不过多说，置为<code>NOP</code></p>
<p>接着到函数的找到函数的行首，<code>P键</code>将其识别为函数</p>
<p>然后F5进入伪代码页面</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230115202922.jpg"></p>
<p>点击函数名，按<code>X键</code>，查看交叉引用，返回到<code>main()</code>中，</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230115203121.jpg"></p>
<p>之后根据伪代码，很简单就能得到相应的flag（会用到一点Crypto中的知识），这里主要说的是花指令，所以就不往下做了。</p>
<p>总结一下，</p>
<ul>
<li><p>汇编中的函数必须由<code>retn</code>结尾</p>
</li>
<li><p>函数开始时一般有这种标志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CC CC CC CC CC CC CC CC CC CC+ align 10h</span><br></pre></td></tr></table></figure>
</li>
<li><p>很典型的一段花指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">loc_4014D7:</span><br><span class="line">mov     [ebp-0DCh], eax</span><br><span class="line">call    sub_4018C0</span><br><span class="line">mov     [ebp-0E0h], eax</span><br><span class="line">call    near ptr loc_4014EF+4</span><br><span class="line">jmp     short near ptr loc_4014D7+1</span><br><span class="line">;-----------------------------------------</span><br><span class="line">loc_4014EF:</span><br><span class="line">add     eax, 83000000h</span><br><span class="line">......</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="SMC"><a href="#SMC" class="headerlink" title="SMC"></a>SMC</h3><blockquote>
<p>SMC(self-Modifying  Code 自修改代码)，就是在真正执行某一段代码时，程序会对自身的该段代码进行自修改，只有在修改后的代码才是可汇编、可执行的。在程序未对该段代码进行修改之前，在静态分析状态下，均是不可读的字节码，IDA之类的反汇编器无法识别程序的正常逻辑</p>
</blockquote>
<p>这个概念一下也不好理解，我们来一道题(<strong>Deliver_TEA_to_dalao</strong>)</p>
<p>用ida打开后发现一切正常，F5反编译出的也没什么问题</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230116120415.jpg"></p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230116120503.jpg"></p>
<p>可以看到关键代码是这个<code>encrypt_0v0()</code>,我们点进去看一下这个函数的内部(<code>双击</code>函数名)</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230116121058.jpg"></p>
<p>看不懂，说明这就不是一个正确的函数。</p>
<p>转到<code>main()</code>再看看</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230116121434.jpg"></p>
<p>有一个<code>ignoreME()</code>对<code>encrypt_0v0()</code>进行了一些处理，进入内部看一下</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230116121503.jpg"></p>
<p>反编译出的逻辑有一点问题，我们修改一下函数返回值和参数类型，就能得到正确的函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __cdecl <span class="title function_">ignoreMe</span><span class="params">(<span class="type">char</span> *a1, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+Ch] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; a2; ++i )</span><br><span class="line">    a1[i] ^= <span class="number">0x56</span>u;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>a1</code>是传入的<code>encrypt_0v0()</code>，所以<code>ignoreMe()</code>，对<code>encrypt_0v0()</code>的地址进行了异或操作。异或之后的地址才是<code>encrypt_0v0()</code>的真是地址。</p>
<p>所以SCM的逻辑是这样的</p>
<ol>
<li><strong>程序在最开始的时候就修改一些代码片段的地址，让其指向错误的地方，这样反编译就会失败，代码片段不能正常执行。</strong></li>
<li><strong>程序中还有一段能将上面的错误地址修改过来的代码，在程序运行的时候这段代码就会执行，将地址修改过来，码片段能正常执行。</strong></li>
</ol>
<p>按照这个逻辑我们能发现，让程序运行完修改地址的函数之后，再反编译，就能得到想要的代码片段。这种方法就叫做<strong>动态调试</strong></p>
<p>还有一种方法，既然函数可以自己修改，那我们手动也可以修改。但是手动一个一个修改的太慢了，所以要用到脚本。这种方法叫<strong>静态修改</strong></p>
<h4 id="动调法"><a href="#动调法" class="headerlink" title="动调法"></a>动调法</h4><p>回到这个题目，在函数得到正确的地址后打个断点，方便查看</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230116124830.jpg"></p>
<p>然后再调试界面选择<code>Local Windows debugger</code>,然后开始调试</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230116125045.jpg"></p>
<p>进去后不管那么多，直接搜索我们要找的函数</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230116134748.jpg"></p>
<p>找到之后发现,代码被识别成了数据</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230116134906.jpg"></p>
<p>接下来就要找到这个函数的边界，也就是找到<code>retn</code>，然后将数据转成代码，再将代码识别为函数就可以了。</p>
<p>改完长这样</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230116135543.jpg"></p>
<p>然后<code>F5</code></p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230116135729.jpg"></p>
<p>可以看到函数的返回值有点问题，应该是<code>void</code>，我们改一下</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230116135844.jpg"></p>
<p>这样就完全搞出来。这时我们停止调试，也可以正常查看了。</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230116140014.jpg"></p>
<p>接下来就是Crypto问题了，这里不再多说。</p>
<h4 id="静态修改"><a href="#静态修改" class="headerlink" title="静态修改"></a>静态修改</h4><p>上面简单讲过原理，这里不再多说，直接给出脚本</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;idc.idc&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="title function_">xor_setp1</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> addr = <span class="number">0x00401448</span>;   <span class="comment">//这里填入要解密字节串的起始地址</span></span><br><span class="line">    <span class="keyword">auto</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;addr+i&lt;=<span class="number">0x00401504</span>;i++)   <span class="comment">//循环结束的条件为字节串的结束地址</span></span><br><span class="line">    &#123;</span><br><span class="line">        PatchByte(addr+i,Byte(addr+i)^<span class="number">0x56</span>);   <span class="comment">//异或的数字根据情况修改</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        xor_setp1();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>还有一个python脚本，原理都一样</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">patch</span>(<span class="params">start,end,key</span>):</span><br><span class="line">    n=<span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span>(start+n!=end+<span class="number">1</span>):</span><br><span class="line">        addr=start+n</span><br><span class="line">        PatchByte(addr,Byte(addr)^key)</span><br><span class="line">        n+=<span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;%d Byte has been changed&quot;</span>%n)</span><br><span class="line"></span><br><span class="line">codeStart=<span class="number">0x401448</span> 	<span class="comment">#要解密字节串的起始地址</span></span><br><span class="line">codeLen=<span class="number">189</span>			<span class="comment">#解密的长度</span></span><br><span class="line">xorData=<span class="number">0x56</span>		<span class="comment">#异或的数值</span></span><br><span class="line">patch(codeStart,codeStart+codeLen-<span class="number">1</span>,xorData)</span><br></pre></td></tr></table></figure>

<p>对不同的题，脚本要进行相应的修改</p>
<p>我们换一道题进行演示(校赛findit)</p>
<p>多余的不多说，这里分析代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v4[<span class="number">40</span>]; <span class="comment">// [esp+18h] [ebp-28h] BYREF</span></span><br><span class="line"></span><br><span class="line">  __main();</span><br><span class="line">  we = ssd;</span><br><span class="line">  <span class="built_in">printf</span>(&amp;Format);</span><br><span class="line">  N1(v4);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __cdecl <span class="title function_">N1</span><span class="params">(<span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  jiake(we, <span class="number">738</span>, <span class="number">5</span>);</span><br><span class="line">  <span class="keyword">return</span> ((<span class="type">int</span> (__cdecl *)(<span class="type">char</span> *))we)(a1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> __cdecl <span class="title function_">jiake</span><span class="params">(<span class="type">char</span> *lpAddress, <span class="type">int</span> a2, <span class="type">char</span> a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">MEMORY_BASIC_INFORMATION</span> <span class="title">Buffer</span>;</span> <span class="comment">// [esp+18h] [ebp-30h] BYREF</span></span><br><span class="line">  DWORD flOldProtect[<span class="number">4</span>]; <span class="comment">// [esp+34h] [ebp-14h] BYREF</span></span><br><span class="line"></span><br><span class="line">  VirtualQuery(lpAddress, &amp;Buffer, <span class="number">0x1C</span>u);</span><br><span class="line">  flOldProtect[<span class="number">2</span>] = VirtualProtect(Buffer.BaseAddress, Buffer.RegionSize, <span class="number">0x40</span>u, &amp;Buffer.Protect);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = a2--;</span><br><span class="line">    flOldProtect[<span class="number">1</span>] = v3;</span><br><span class="line">    <span class="keyword">if</span> ( !v3 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    *lpAddress++ ^= a3;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> VirtualProtect(Buffer.BaseAddress, Buffer.RegionSize, Buffer.Protect, flOldProtect);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里可以看出来，<code>N1()</code>这个函数就是对地址进行修改的。而且进行修改的函数就是<code>jiake()</code>这个函数。修改的的<code>we</code>的地址，而<code>we</code>的值就是<code>ssd</code>传过去的，所以 最终修改的<code>ssd</code>的地址，我们接下来要找到<code>ssd</code>的首地址。</p>
<p>选定<code>ssd</code>后按<code>TAB</code></p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230116143004.jpg"></p>
<p>跳转到这个界面</p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230116143127.jpg"></p>
<p>选定后<code>双击</code></p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230116143141.jpg"></p>
<p>找到函数首地址<code>0x401500</code></p>
<p>根据<code>jiake()</code>得到异或的值是<code>0x5</code>，长度是<code>738</code>也就是<code>0x2E2</code></p>
<p>修改一下脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">patch</span>(<span class="params">start,end,key</span>):</span><br><span class="line">    n=<span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span>(start+n!=end+<span class="number">1</span>):</span><br><span class="line">        addr=start+n</span><br><span class="line">        PatchByte(addr,Byte(addr)^key)</span><br><span class="line">        n+=<span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;%d Byte has been changed&quot;</span>%n)</span><br><span class="line"></span><br><span class="line">codeStart=<span class="number">0x401500</span> 	<span class="comment">#要解密字节串的起始地址</span></span><br><span class="line">codeLen=<span class="number">738</span>			<span class="comment">#解密的长度</span></span><br><span class="line">xorData=<span class="number">0x5</span>			<span class="comment">#异或的数值</span></span><br><span class="line">patch(codeStart,codeStart+codeLen-<span class="number">1</span>,xorData)</span><br></pre></td></tr></table></figure>

<p>保存为文件，然后<code>File&gt;&gt;Script File&gt;&gt;选择文件</code></p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230116144822.jpg"></p>
<p>执行完后是这样，稍微再修一下，修好之后直接<code>F5</code>得到<code>ssd()</code></p>
<p><img src="/./assets/QQ%E6%88%AA%E5%9B%BE20230116145048.jpg"></p>
<p>接下来不多说了。</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/06/01/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86%E5%AE%9E%E9%AA%8C%E4%B8%80/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">&lt;</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2023/06/01/python%E5%9C%A8ctf%E4%B8%AD%E7%9A%84%E9%83%A8%E5%88%86%E5%BA%94%E7%94%A8/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title"></div>
      <strong class="article-nav-caption">&gt;</strong>
    </a>
  
</nav>

  
</article>


<div class="ds-share share" data-thread-key="re学习总结" data-title="" data-url="http://gaoxudong.top/2023/06/01/re%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/"  data-images="http://7xkj1z.com1.z0.glb.clouddn.com/head.jpg" data-content="">
    <div class="ds-share-inline">
      <ul  class="ds-share-icons-16">
      	<li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
        <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
        <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li>
        <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">腾讯微博</a></li>
        <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>
      </ul>
      <div class="ds-share-icons-more">
      </div>
    </div>
 </div>
 





</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2023 sharkhhhh
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/smackgg/hexo-theme-smackdown" target="_blank">Smackdown</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">



<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>

<script src="/js/main.js"></script>




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js"></script>


  </div>
</body>
</html>